// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  admin
  sales
  user
}

enum LogAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
}

enum EntityType {
  USER
  PRODUCT
  SERVICE
  SALE
  CUSTOMER
  POS_SESSION
  CATEGORY
  AUTH
  BLOG
  MEDIA
  THERAPIST
  APPOINTMENT
  PATIENT_RECORD
}

model AppLogs {
  id        String     @id @default(cuid())
  userId    String
  action    String
  entity    EntityType
  entityId  String?
  details   String?
  timestamp DateTime   @default(now())

  user User @relation(fields: [userId], references: [id])

  @@map("app_logs")
}

model User {
  id           String   @id @default(cuid())
  username     String   @unique
  role         Role     @default(user)
  name         String
  lastName     String?
  passwordHash String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  posSessions   PosSession[]   @relation("openedBy")
  refreshTokens RefreshToken[]
  appLogs       AppLogs[]
  blogPosts     BlogPost[]
  therapists Therapist[]

  @@map("users")
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("refresh_tokens")
}

model Category {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  products Product[]

  @@map("categories")
}

model Product {
  id          String   @id @default(cuid())
  name        String   @unique
  sku         String   @unique @default(uuid())
  slug        String   @unique
  shortDesc   String?
  longDesc    String?
  price       Int
  cost        Int
  stock       Int      @default(0)
  minStock    Int      @default(0)
  isActive    Boolean  @default(true)
  isPublished Boolean  @default(true)
  categoryId  String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  category   Category       @relation(fields: [categoryId], references: [id])
  sales      SaleItem[]
  mediaFiles ProductMedia[]

  @@map("products")
}

model Service {
  id              String   @id @default(cuid())
  code            String   @unique @default(uuid())
  name            String   @unique
  slug            String   @unique
  longDesc        String?
  shortDesc       String?
  price           Int
  cost            Int
  durationMinutes Int
  isActive        Boolean  @default(true)
  isPublished     Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  sales      SaleItem[]
  mediaFiles ServiceMedia[]
  therapists TherapistService[]
  appointments Appointment[]

  @@map("services")
}

model PosSession {
  id          String        @id @default(cuid())
  openedAt    DateTime      @default(now())
  closedAt    DateTime?
  initialCash Int
  finalCash   Int?
  status      SessionStatus
  notes       String?
  openedById  String
  sales       Sale[]
  user        User[]        @relation("openedBy")

  @@map("pos_sessions")
}

enum SessionStatus {
  OPEN
  CLOSED
}

enum PaymentMethod {
  CASH
  CREDIT_CARD
  DEBIT_CARD
  TRANSFER
  MIXED
}

model Customer {
  id        String   @id @default(cuid())
  name      String
  lastName  String?
  email     String?  @unique
  phone     String?  @unique
  points    Int      @default(0)
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sales Sale[]
  appointments Appointment[]
  records PatientRecord[]

  @@map("customers")
}

model Sale {
  id            String        @id @default(cuid())
  posSessionId  String
  receiptNumber String        @unique
  subtotal      Int
  tax           Int
  discount      Int
  total         Int
  paymentMethod PaymentMethod
  customerId    String?
  notes         String?

  createdAt DateTime @default(now())

  posSession PosSession @relation(fields: [posSessionId], references: [id])
  customer   Customer?  @relation(fields: [customerId], references: [id])
  saleItems  SaleItem[]

  @@map("sales")
}

model SaleItem {
  id         String  @id @default(cuid())
  saleId     String
  productId  String?
  serviceId  String?
  quantity   Int
  unitPrice  Int
  totalPrice Int

  sale    Sale     @relation(fields: [saleId], references: [id])
  product Product? @relation(fields: [productId], references: [id])
  service Service? @relation(fields: [serviceId], references: [id])

  @@map("sale_items")
}

model Media {
  id        String   @id @default(cuid())
  alt       String?
  url       String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  productsMedia  ProductMedia[]
  servicesMedia  ServiceMedia[]
  blogPostsMedia BlogPostMedia[]

  @@map("media")
}

model ProductMedia {
  productId  String
  mediaId    String
  orderIndex Int     @default(0)
  product    Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  media      Media   @relation(fields: [mediaId], references: [id], onDelete: Cascade)

  @@id([productId, mediaId])
  @@map("product_media")
}

model ServiceMedia {
  serviceId  String
  mediaId    String
  orderIndex Int     @default(0)
  service    Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  media      Media   @relation(fields: [mediaId], references: [id], onDelete: Cascade)

  @@id([serviceId, mediaId])
  @@map("service_media")
}

model BlogPost {
  id        String   @id @default(cuid())
  title     String
  slug      String   @unique
  content   Json
  excerpt   String?
  tags      String[]
  authorId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  mediaFiles BlogPostMedia[]
  author     User            @relation(fields: [authorId], references: [id])

  @@map("blog_posts")
}

model BlogPostMedia {
  blogPostId String
  mediaId    String
  orderIndex Int    @default(0)

  blogPost BlogPost @relation(fields: [blogPostId], references: [id], onDelete: Cascade)
  media    Media    @relation(fields: [mediaId], references: [id], onDelete: Cascade)

  @@id([blogPostId, mediaId])
  @@map("blog_post_media")
}

model Therapist {
  id String @id @default(cuid())
  userId String? @unique
  name String
  lastName String
  email String? @unique
  phone String?
  isActive Boolean @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  services TherapistService[]
  schedule TherapistSchedule[]
  user User? @relation(fields: [userId], references: [id])



  appointments Appointment[]

  patientRecords PatientRecord[]

  @@map("therapists")
}

model TherapistService {
  therapistId String
  serviceId String

  therapist Therapist @relation(fields: [therapistId], references: [id], onDelete: Cascade)
  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@id([therapistId, serviceId])
  @@map("therapist_services")
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

model TherapistSchedule {
  id          String    @id @default(cuid())
  therapistId String
  dayOfWeek   DayOfWeek
  startTime   String
  endTime     String
  isActive    Boolean   @default(true)

  therapist Therapist @relation(fields: [therapistId], references: [id], onDelete: Cascade)

  @@unique([therapistId, dayOfWeek])
  @@map("therapist_schedules")
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
  NO_SHOW
}

model Appointment {
  id              String            @id @default(cuid())
  customerId      String
  therapistId     String?
  serviceId       String
  appointmentDate DateTime
  durationMinutes Int
  status          AppointmentStatus @default(PENDING)
  notes           String?
  reminderSent    Boolean           @default(false)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  customer       Customer       @relation(fields: [customerId], references: [id])
  therapist      Therapist?     @relation(fields: [therapistId], references: [id])
  service        Service        @relation(fields: [serviceId], references: [id])
  patientRecord  PatientRecord?

  @@index([therapistId, appointmentDate])
  @@index([customerId])
  @@map("appointments")
}

model PatientRecord {
  id              String   @id @default(cuid())
  appointmentId   String   @unique
  customerId      String
  generalNotes    String?
  medicalHistory  String?
  allergies       String?
  medications     String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  updatedById     String

  appointment    Appointment   @relation(fields: [appointmentId], references: [id])
  therapist      Therapist     @relation(fields: [updatedById], references: [id])
  customer       Customer      @relation(fields: [customerId], references: [id])
  sessionNotes   SessionNote[]

  @@index([customerId])
  @@index([updatedById])
  @@map("patient_records")
}

model SessionNote {
  id              String   @id @default(cuid())
  patientRecordId String
  sessionDate     DateTime
  notes           String
  observations    String?
  nextSteps       String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  patientRecord PatientRecord @relation(fields: [patientRecordId], references: [id], onDelete: Cascade)

  @@index([patientRecordId])
  @@map("session_notes")
}